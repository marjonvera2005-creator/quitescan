{% extends 'base.html' %}
{% load static %}

{% block title %}Scan QR Code - QUITESCAN{% endblock %}

{% block extra_css %}
<style>
    #qr-video {
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
    }
    .scan-overlay {
        position: relative;
        display: inline-block;
    }
    .scan-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 3px solid #FFD700;
        border-radius: 15px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    .scan-corners {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 3px solid #FFD700;
    }
    .scan-corner-tl {
        top: -3px;
        left: -3px;
        border-right: none;
        border-bottom: none;
        border-radius: 15px 0 0 0;
    }
    .scan-corner-tr {
        top: -3px;
        right: -3px;
        border-left: none;
        border-bottom: none;
        border-radius: 0 15px 0 0;
    }
    .scan-corner-bl {
        bottom: -3px;
        left: -3px;
        border-right: none;
        border-top: none;
        border-radius: 0 0 0 15px;
    }
    .scan-corner-br {
        bottom: -3px;
        right: -3px;
        border-left: none;
        border-top: none;
        border-radius: 0 0 15px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto text-center">
    <!-- Hidden CSRF token for JavaScript -->
    {% csrf_token %}
    <!-- Header -->
    <div class="gradient-bg rounded-2xl p-8 text-white mb-8">
        <h1 class="text-4xl font-bold mb-2">Scan QR Code</h1>
        <p class="text-xl">Point your camera at the QR code to check in or out</p>
    </div>

    <!-- Camera Section -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
        <div class="scan-overlay">
            <video id="qr-video" width="400" height="300" autoplay></video>
            <div class="scan-frame">
                <div class="scan-corners scan-corner-tl"></div>
                <div class="scan-corners scan-corner-tr"></div>
                <div class="scan-corners scan-corner-bl"></div>
                <div class="scan-corners scan-corner-br"></div>
            </div>
        </div>
        
        <div class="mt-6">
            <button id="start-camera" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition duration-200 hover-scale">
                üì∑ Start Camera
            </button>
            <button id="stop-camera" class="bg-gray-500 text-white px-8 py-3 rounded-xl font-semibold hover:bg-gray-600 transition duration-200 ml-4 hidden">
                ‚èπÔ∏è Stop Camera
            </button>
        </div>
    </div>

    <!-- Manual Input Section -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manual QR Code Entry</h2>
        <div class="max-w-md mx-auto">
            <input type="text" id="manual-qr" placeholder="Enter QR code manually" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition duration-200 mb-4">
            <button id="submit-manual" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-8 py-3 rounded-xl font-semibold hover:from-yellow-600 hover:to-orange-600 transition duration-200 hover-scale">
                Submit
            </button>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-message" class="hidden">
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div id="status-content"></div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-2xl p-6">
        <div class="flex items-start">
            <div class="text-2xl mr-4">üì±</div>
            <div class="text-left">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">How to use:</h3>
                <ul class="text-gray-600 space-y-2">
                    <li class="flex items-center">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></span>
                        Allow camera access when prompted
                    </li>
                    <li class="flex items-center">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></span>
                        Point your camera at the QR code
                    </li>
                    <li class="flex items-center">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></span>
                        The system will automatically detect and process the code
                    </li>
                    <li class="flex items-center">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></span>
                        Or manually enter the QR code if needed
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/jsQR.min.js' %}"></script>
<script>
let video = document.getElementById('qr-video');
let canvas = document.createElement('canvas');
let ctx = canvas.getContext('2d');
let scanning = false;
let stream = null;

// Start camera
document.getElementById('start-camera').addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 400 },
                height: { ideal: 300 }
            } 
        });
        video.srcObject = stream;
        document.getElementById('start-camera').classList.add('hidden');
        document.getElementById('stop-camera').classList.remove('hidden');
        scanning = true;
        scanQR();
    } catch (err) {
        showStatus('Camera access denied. Please use manual entry.', 'error');
    }
});

// Stop camera
document.getElementById('stop-camera').addEventListener('click', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
    document.getElementById('start-camera').classList.remove('hidden');
    document.getElementById('stop-camera').classList.add('hidden');
    scanning = false;
});

// Manual QR submission
document.getElementById('submit-manual').addEventListener('click', () => {
    const qrCode = document.getElementById('manual-qr').value.trim();
    if (qrCode) {
        processQRCode(qrCode);
    } else {
        showStatus('Please enter a QR code', 'error');
    }
});

// QR scanning function
function scanQR() {
    if (!scanning) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            processQRCode(code.data);
            return;
        }
    }
    
    requestAnimationFrame(scanQR);
}

// Process QR code (offline-first with queue)
function processQRCode(qrCode) {
    const payload = { qr_code: qrCode };
    const send = () => fetch('{% url "process_scan" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(payload)
    }).then(r => {
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        return r.json();
    });

    // Always try to send first, only queue if it fails
    send().then(handleScanResponse).catch((error) => {
        console.log('Network error:', error);
        // Only queue if it's actually a network error, not a server error
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            queueAndNotify(payload);
        } else {
            showStatus('Server error: ' + error.message, 'error');
        }
    });
}

function handleScanResponse(data) {
    if (data.success) {
        showStatus(data.message, 'success', data);
    } else {
        showStatus(data.message, 'error');
    }
}

function queueAndNotify(payload) {
    try {
        const key = 'scan_queue';
        const q = JSON.parse(localStorage.getItem(key) || '[]');
        q.push({ payload, ts: Date.now() });
        localStorage.setItem(key, JSON.stringify(q));
        showStatus('No internet. Saved scan locally and will sync when online.', 'success');
    } catch (e) {
        showStatus('Offline and failed to save scan locally.', 'error');
    }
}

window.addEventListener('online', function () {
    // Try to flush queue
    const key = 'scan_queue';
    const q = JSON.parse(localStorage.getItem(key) || '[]');
    if (q.length === 0) return;
    const next = q.shift();
    localStorage.setItem(key, JSON.stringify(q));
    fetch('{% url "process_scan" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(next.payload)
    })
    .then(r => r.json())
    .then(handleScanResponse)
    .catch(() => {
        // push back if still failing
        const q2 = JSON.parse(localStorage.getItem(key) || '[]');
        q2.unshift(next);
        localStorage.setItem(key, JSON.stringify(q2));
    });
});

// Show status message
function showStatus(message, type, data = null) {
    const statusDiv = document.getElementById('status-message');
    const contentDiv = document.getElementById('status-content');
    
    let html = '';
    if (type === 'success') {
        html = `
            <div class="text-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h3 class="text-2xl font-bold text-green-600 mb-2">Success!</h3>
                <p class="text-lg text-gray-700 mb-4">${message}</p>
                ${data ? `
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                        <p class="font-semibold text-green-800">Student: ${data.student_name}</p>
                        <p class="text-green-700">Action: ${data.action}</p>
                        <p class="text-green-700">Time: ${data.timestamp}</p>
                    </div>
                ` : ''}
                <button onclick="location.reload()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                    Scan Another
                </button>
            </div>
        `;
    } else {
        html = `
            <div class="text-center">
                <div class="text-6xl mb-4">‚ùå</div>
                <h3 class="text-2xl font-bold text-red-600 mb-2">Error</h3>
                <p class="text-lg text-gray-700 mb-4">${message}</p>
                <button onclick="document.getElementById('status-message').classList.add('hidden')" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                    Try Again
                </button>
            </div>
        `;
    }
    
    contentDiv.innerHTML = html;
    statusDiv.classList.remove('hidden');
    statusDiv.scrollIntoView({ behavior: 'smooth' });
}

// Add CSRF token
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        const token = document.createElement('input');
        token.type = 'hidden';
        token.name = 'csrfmiddlewaretoken';
        token.value = '{{ csrf_token }}';
        document.body.appendChild(token);
    }
});
</script>
{% endblock %}
